{"version":3,"sources":["nextjournal/viewer/plotly.cljs"],"mappings":"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","names":["nextjournal.viewer.plotly/default-layout","G__94880","and__4251__auto__","js/window","cljs.core.assoc","nextjournal.viewer.plotly/default-graph-options","nextjournal.viewer.plotly/default-min-margin","nextjournal.viewer.plotly/adjust-layout-margins","layout","cljs.core.update","margin","cljs.core.merge_with","cljs.core/max","cljs.core.get","nextjournal.viewer.plotly/deep-merge-maps","m1","m2","cljs.core/map?","nextjournal.viewer.plotly/graph-layout-with-defaults","cljs.core.js__GT_clj","cljs.core/empty?","cljs.core/clj->js","nextjournal.viewer.plotly/coerce-val","value","js/JSON","nextjournal.viewer.plotly/viewer*","this","reagent.core/current-component","nextjournal.ui.components.d3-require/with","p__94899","map__94903","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","obj94905","js/undefined","obj94906","Plotly","relayout","Plots","plotly-el","map__94907","obj94909","coerced","value-object","obj94911","out94912","k__83550__auto__","applied-science.js-interop.impl/in?*","obj94915","obj94916","obj94910","obj94919","obj94920","obj94923","obj94924","goog.functions/debounce","G__94927","G__94928","obj__83643__auto__","f__83644__auto__","reason","lambdaisland.glogi.log","cljs.core/identity","obj94930","obj94931","nextjournal.viewer.plotly/viewer"],"sourcesContent":["(ns nextjournal.viewer.plotly\n  (:require [applied-science.js-interop :as j]\n            [goog.functions :as gf]\n            [nextjournal.log :as log]\n            [nextjournal.ui.components.d3-require :as d3-require]\n            [reagent.core :as r]))\n\n(def default-layout\n  (cond-> {\"font\" {\"family\" \"'Verlag A', 'Verlag B', -apple-system, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Arial', sans-serif\"\n                   \"size\" 14\n                   \"color\" \"#343434\"}\n           \"height\" 450\n           \"autosize\" false}\n    (and (exists? js/window) (.hasOwnProperty js/window \"ontouchstart\"))\n    (assoc \"dragmode\" false)))\n\n(def default-graph-options #js {:displayModeBar false\n                                :displayLogo false})\n\n(def default-min-margin {\"r\" 0 \"l\" 30 \"b\" 0 \"t\" 20})\n\n(defn adjust-layout-margins [layout]\n  (update layout \"margin\"\n          (fn [margin]\n            (merge-with max\n                        default-min-margin\n                        margin\n                        (when (get layout \"title\")\n                          {\"t\" 60})))))\n\n(defn deep-merge-maps\n  \"Like merge, but merges maps recursively.\"\n  [m1 m2]\n  (if (and (map? m1) (map? m2))\n    (merge-with deep-merge-maps m1 m2)\n    m2))\n\n(defn graph-layout-with-defaults [layout]\n  (let [layout (js->clj layout)\n        layout (if (empty? layout) {} layout)]\n    (-> (deep-merge-maps default-layout layout)\n        adjust-layout-margins\n        clj->js)))\n\n(defn coerce-val [value]\n  (cond\n    (string? value)\n    (.parse js/JSON value)\n    (map? value)\n    (clj->js value)\n    :else\n    value))\n\n(defn viewer* [value]\n  (let [this (r/current-component)]\n    [d3-require/with {:package \"plotly.js-dist@1.51.1\"}\n     (j/fn [^:js {:as Plotly :keys [relayout Plots]}]\n       [:div.code-plotly-result\n        {:class \"flex justify-center items-center\"\n         :ref (fn [^js plotly-el]\n                (if plotly-el\n                  (j/let [^:js {:keys [layout] :as coerced} (coerce-val value)\n                          value-object (-> coerced\n                                           (j/select-keys [:data :frames])\n                                           (j/assoc! :layout (graph-layout-with-defaults layout)\n                                                     :config default-graph-options))]\n                    (j/assoc! this :resize-listener\n                              (gf/debounce\n                               (fn []\n                                 (relayout plotly-el (clj->js (graph-layout-with-defaults layout)))\n                                 (-> Plots (.resize plotly-el)))\n                               100))\n                    (-> Plotly\n                        (j/call :newPlot\n                                plotly-el\n                                value-object)\n                        (j/call :catch\n                                (fn new-plot-error [reason]\n                                  (log/error ::insert-plot \"Plotly Error\" :el plotly-el :reason reason))))\n                    (.addEventListener js/window \"resize\" (j/get this :resize-listener)))\n                  (.removeEventListener js/window \"resize\" (j/get this :resize-listener))))}])]))\n\n;; wrapper is used so that `viewer*` is not called as a function - it needs its own reagent component\n(defn viewer [value]\n  ^{:nextjournal/viewer :reagent} [viewer* value])\n"]}