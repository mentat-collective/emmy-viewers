shadow$provide.module$node_modules$mathbox$build$esm$model$model=function(global,require,module,exports){Object.defineProperty(exports,"__esModule",{value:!0});exports.Model=void 0;var _cssSelectAdapted=require("module$node_modules$mathbox$build$esm$model$css_select_adapted");const AUTO=/^<([0-9]+|<*)$/;class Model{constructor(root){this.root=root;this.root.model=this;this.root.root=this.root;this.ids={};this.classes={};this.traits={};this.types={};this.nodes=[];this.watchers=[];this.fire=!1;this.lastNode=
null;this.event={type:"update"};this.root.on("add",event=>adopt(event.node));this.root.on("remove",event=>{event=event.node;removeNode(event);removeType(event);removeTraits(event);removeID(event.id,event);removeClasses(event.classes,event);event.off("change:node",update);return force(event)});const adopt=node=>{addNode(node);addType(node);addTraits(node);node.on("change:node",update);update(null,node,!0);return force(node)},prime=node=>{for(const watcher of Array.from(this.watchers))watcher.match=
watcher.matcher(node);return null},check=node=>{for(const watcher of Array.from(this.watchers)){const fire=watcher.fire||(watcher.fire=watcher.match!==watcher.matcher(node));fire&&(this.lastNode=node);this.fire||(this.fire=fire)}return null},force=node=>{for(const watcher of Array.from(this.watchers)){const fire=watcher.fire||(watcher.fire=watcher.matcher(node));fire&&(this.lastNode=node);this.fire||(this.fire=fire)}return null};this.digest=()=>{if(!this.fire)return!1;for(const watcher of Array.from(this.watchers.slice()))watcher.fire&&
(watcher.fire=!1,watcher.handler());this.fire=!1;return!0};const update=(event,node,init)=>{var _klass=init||event.changed["node.classes"];let primed=!1;if(init||event.changed["node.id"])event=node.get("node.id"),event!==node.id&&(init||prime(node),primed=!0,null!=node.id&&removeID(node.id,node),addID(event,node));if(_klass){var left;_klass=null!=(left=node.get("node.classes"))?left:[];left=_klass.join(",");left!==(null!=node.classes?node.classes.klass:void 0)&&(_klass=_klass.slice(),init||primed||
prime(node),primed=!0,null!=node.classes&&removeClasses(node.classes,node),addClasses(_klass,node),node.classes=_klass,node.classes.klass=left)}!init&&primed&&check(node);return null},addTags=function(sets,tags,node){if(null!=tags){for(const k of Array.from(tags))tags=null!=sets[k]?sets[k]:[],tags.push(node),sets[k]=tags;return null}},removeTags=function(sets,tags,node){if(null!=tags){for(const k of Array.from(tags)){tags=sets[k];const index=tags.indexOf(node);0<=index&&tags.splice(index,1);0===tags.length&&
delete sets[k]}return null}},hashTags=function(array){if(0<array.length){var hash=array.hash={};return Array.from(array).map(klass=>hash[klass]=!0)}},addID=(id,node)=>{if(this.ids[id])throw Error(`Duplicate node id \`${id}\``);null!=id&&(this.ids[id]=[node]);return node.id=null!=id?id:node._id},removeID=(id,node)=>{null!=id&&delete this.ids[id];return node.id=node._id},addClasses=(classes,node)=>{addTags(this.classes,classes,node);if(null!=classes)return hashTags(classes)},removeClasses=(classes,
node)=>{removeTags(this.classes,classes,node);if(null!=classes)return delete classes.hash},addNode=node=>this.nodes.push(node),removeNode=node=>this.nodes.splice(this.nodes.indexOf(node),1),addType=node=>addTags(this.types,[node.type],node),removeType=node=>removeTags(this.types,[node.type],node),addTraits=node=>{addTags(this.traits,node.traits,node);return hashTags(node.traits)},removeTraits=node=>{removeTags(this.traits,node.traits,node);return delete node.traits.hash};adopt(this.root);this.root.trigger({type:"added"})}select(query,
context){return(0,_cssSelectAdapted.selectAll)(query,context||this.getRoot())}watch(selector,handler){let watcher;handler.unwatch=()=>this.unwatch(handler);handler.watcher=watcher={selector,handler,matcher:this._matcher(selector),match:!1,fire:!1};this.watchers.push(watcher);return this.select(selector)}unwatch(handler){const {watcher}=handler;if(null!=watcher)return this.watchers.splice(this.watchers.indexOf(watcher),1),delete handler.unwatch,delete handler.watcher}_matcher(query){if(AUTO.test(query))throw Error("Auto-link matcher unsupported");
return(0,_cssSelectAdapted.compile)(query)}getRoot(){return this.root}getLastTrigger(){return this.lastNode.toString()}}exports.Model=Model}
//# sourceMappingURL=module$node_modules$mathbox$build$esm$model$model.js.map
