{"version":3,"sources":["nextjournal/view.cljs"],"mappings":"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","names":["nextjournal.view/memoized-frame-fn","component","memo-key","ctx-function","val__83515__auto__","obj88645","js/undefined","f","cljs.core.partial","obj88646","obj88647","obj88648","nextjournal.view/get-key","k","not-found","G__88652","cljs.core/Keyword","reagent.core/props","reagent.core/state-atom","reagent.core/argv","obj88654","re-frame.frame/subscribe","re-frame.frame/dispatch","re-frame.frame/dispatch-sync","cljs.core.get","nextjournal.view/wrap-render","c","argv","reagent.impl.component/get-argv","props?","n","cljs.core/count","first-child","extra-children","G__88656","cljs.core.nth","cljs.core.into_array","p__88660","map__88661","cljs.core/--destructure-map","initial-state","nextjournal.view/constructor-fn","constructor","p__88662","map__88667","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","obj88669","js/goog.reflect.objectProperty","this","props","x88671","o","temp__5757__auto__","or__4253__auto__","G__88673","reagent.impl.component/extract-props","state","cljs.core/fn?","state-atom","G__88674","reagent.ratom/RAtom","reagent.core.atom","nextjournal.view/wrap-methods","m","cljs.core.assoc","js/nextjournal","js/nextjournal.view","js/nextjournal.view.*notify-watches?*","nextjournal.view/*notify-watches?*","js/window","obj88679","inner-obj__83626__auto__","child88684","child88683","new-child__83575__auto__","obj88689","obj88692","obj88695","o__83620__auto__","o__83614__auto__","obj88698","notify-w","old","new","var_args","args__4870__auto__","len__4864__auto__","i__4865__auto__","argseq__4871__auto__","cljs.core/IndexedSeq","nextjournal.view/swap-silently!","seq88699","self__4852__auto__","cljs.core/seq","args","*notify-watches?*-orig-val__88700","*notify-watches?*-temp-val__88701","cljs.core/swap!","nextjournal.view/reset-silently!","ratom","value","*notify-watches?*-orig-val__88702","*notify-watches?*-temp-val__88703","cljs.core/reset!"],"sourcesContent":["(ns nextjournal.view\n  (:require [applied-science.js-interop :as j]\n            [re-frame.context :as re-frame]\n            [re-frame.frame :as frame]\n            [reagent.core :as r]\n            [reagent.impl.component :as c]\n            [reagent.ratom :as ratom])\n  (:require-macros [nextjournal.view :as v]))\n\n(defn memoized-frame-fn\n  ;; only create these partially-applied functions once per component.\n  ;; same outcome as `with-let`\n  [component ^string memo-key ctx-function]\n  (j/get component memo-key\n         (let [f (partial ctx-function (j/get component :context))]\n           (j/assoc! component memo-key f)\n           f)))\n\n(defn get-key\n  \"Reads a key from `component`\"\n  [component k not-found]\n  (case k ::props (r/props component)\n          ::state (r/state-atom component)\n          ::argv (r/argv component)\n\n          ::re-frame/frame (j/get component :context)\n          ::re-frame/subscribe (memoized-frame-fn component \"rf_subscribe\" frame/subscribe)\n          ::re-frame/dispatch (memoized-frame-fn component \"rf_dispatch\" frame/dispatch)\n          ::re-frame/dispatch-sync (memoized-frame-fn component \"rf_dispatch_sync\" frame/dispatch-sync)\n\n          ;; add other keys here\n\n          ;; fall back to reading keys from props\n          (get (r/props component) k not-found)))\n\n(defn wrap-render [f]\n  ;; the render-function is always be passed `this` as the first argument,\n  ;; followed by child elements, NOT including a props map - props can be read\n  ;; from `this`\n  (fn [c]\n    (let [argv (c/get-argv c)\n          props? (some? (r/props c))\n          n (count argv)\n          first-child (if props? 2 1)\n          extra-children (if props? (- n 2) (- n 1))]\n      (case extra-children\n        0 (.call f c c)\n        1 (.call f c c (nth argv first-child))\n        2 (.call f c c (nth argv first-child) (nth argv (+ 1 first-child)))\n        3 (.call f c c (nth argv first-child) (nth argv (+ 1 first-child)) (nth argv (+ 2 first-child)))\n        4 (.call f c c (nth argv first-child) (nth argv (+ 1 first-child)) (nth argv (+ 2 first-child)) (nth argv (+ 3 first-child)))\n        (.apply f c (.slice (into-array argv) 1))))))\n\n(defn constructor-fn [{:keys [constructor ::initial-state]}]\n  (j/fn [^js this ^:js {:as props :syms [argv]}]\n\n    (specify! this\n      ILookup\n      (-lookup\n        ([o k] (get-key o k nil))\n        ([o k not-found] (get-key o k not-found))))\n\n    ;; initial-state can be provided statically in methods-map, or passed in as a prop (eg. for devcards)\n    (when-some [initial-state (or (some-> argv (c/extract-props) ::initial-state)\n                                  initial-state)]\n      (let [state (if (fn? initial-state) (initial-state this) initial-state)\n            state-atom (cond-> state\n                         (not (instance? ratom/RAtom state)) r/atom)]\n        (set! (.-cljsState this) state-atom)))\n\n    (when constructor (constructor this props))\n    this))\n\n(defn wrap-methods [m]\n  (-> m\n      (assoc :constructor (constructor-fn m))))\n\n;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;\n;; Silent updates\n;;\n;; (useful where you want to update a view's state-atom\n;;  without triggering an update)\n\n(defonce ^:dynamic *notify-watches?*\n  ;; patch Reagent to enable disabling of reactive updates\n  ;; TODO - verify that this works in advanced.\n  ;;        can't use ratom/notify-w, b/c it is private.\n  (do (when (exists? js/window)\n        (j/update-in! js/window [.-reagent .-ratom .-notify-w]\n                      (fn [notify-w]\n                        (fn [this old new]\n                          (when (true? *notify-watches?*)\n                            (notify-w this old new))))))\n      true))\n\n(defn swap-silently!\n  \"Swap a reactive atom, without causing dependent components to re-render.\"\n  [& args]\n  (v/silently (apply swap! args)))\n\n(defn reset-silently!\n  [ratom value]\n  (v/silently (reset! ratom value)))\n\n"]}