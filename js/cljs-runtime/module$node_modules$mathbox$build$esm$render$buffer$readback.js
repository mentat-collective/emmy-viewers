shadow$provide.module$node_modules$mathbox$build$esm$render$buffer$readback=function(global,require,module,exports){function _getRequireWildcardCache(nodeInterop$jscomp$0){if("function"!==typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop$jscomp$0)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;
if(null===obj||"object"!==typeof obj&&"function"!==typeof obj)return{default:obj};if((nodeInterop=_getRequireWildcardCache(nodeInterop))&&nodeInterop.has(obj))return nodeInterop.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor,key;for(key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,
desc):newObj[key]=obj[key]}newObj.default=obj;nodeInterop&&nodeInterop.set(obj,newObj);return newObj}Object.defineProperty(exports,"__esModule",{value:!0});exports.Readback=void 0;var UData=_interopRequireWildcard(require("module$node_modules$mathbox$build$esm$util$data")),UGLSL=_interopRequireWildcard(require("module$node_modules$mathbox$build$esm$util$glsl")),_constants=require("module$node_modules$three$src$constants"),_memo=require("module$node_modules$mathbox$build$esm$render$buffer$memo"),_memoscreen=
require("module$node_modules$mathbox$build$esm$render$meshes$memoscreen");global=require("module$node_modules$mathbox$build$esm$render$renderable");var _Vector=require("module$node_modules$three$src$math$Vector4");class Readback extends global.Renderable{constructor(renderer,shaders,options){super(renderer,shaders);null==this.items&&(this.items=options.items||1);null==this.channels&&(this.channels=options.channels||4);null==this.width&&(this.width=options.width||1);null==this.height&&(this.height=
options.height||1);null==this.depth&&(this.depth=options.depth||1);null==this.type&&(this.type=options.type||_constants.FloatType);null==this.stpq&&(this.stpq=options.stpq||!1);this.isFloat=this.type===_constants.FloatType;this.active=this.sampled=this.rect=this.pad=null;this.build(options)}build(options){let stretch;({map:channels}=options);({indexer:encoder}=options);options=null!=encoder&&!encoder.empty();let {stpq}=this;const {items,width,height,depth}=this;let sampler=channels;options&&(this._adopt({indexModulus:{type:"v4",
value:new _Vector.Vector4(items,items*width,items*width*height,1)}}),sampler=this.shaders.shader(),sampler.require(channels),sampler.require(encoder),sampler.pipe("float.index.pack",this.uniforms));this.isFloat&&1<this.channels&&(this.floatMemo=new _memo.Memo(this.renderer,this.shaders,{items,channels:4,width,height,depth,history:0,type:_constants.FloatType}),this.floatCompose=new _memoscreen.MemoScreen(this.renderer,this.shaders,{map:sampler,items,width,height,depth,stpq}),this.floatMemo.adopt(this.floatCompose),
stpq=!1,sampler=this.shaders.shader(),this.floatMemo.shaderAbsolute(sampler));if(this.isFloat){stretch=this.channels;var channels=4}else stretch=1,channels=this.channels;if(1<stretch){var encoder=this.shaders.shader();encoder.pipe(UGLSL.mapByte2FloatOffset(stretch));encoder.require(sampler);encoder.pipe("float.stretch");encoder.pipe("float.encode");sampler=encoder}else this.isFloat&&(encoder=this.shaders.shader(),encoder.pipe(sampler),encoder.pipe(UGLSL.truncateVec(4,1)),encoder.pipe("float.encode"),
sampler=encoder);this.byteMemo=new _memo.Memo(this.renderer,this.shaders,{items:items*stretch,channels,width,height,depth,history:0,type:_constants.UnsignedByteType});this.byteCompose=new _memoscreen.MemoScreen(this.renderer,this.shaders,{map:sampler,items:items*stretch,width,height,depth,stpq});this.byteMemo.adopt(this.byteCompose);this.samples=this.width*this.height*this.depth;this.bytes=new Uint8Array(items*width*stretch*height*depth*4);this.isFloat&&(this.floats=new Float32Array(this.bytes.buffer));
this.data=this.isFloat?this.floats:this.bytes;this.streamer=this.generate(this.data);this.active={items:0,width:0,height:0,depth:0};this.sampled={items:0,width:0,height:0,depth:0};this.rect={w:0,h:0};this.pad={x:0,y:0,z:0,w:0};this.stretch=stretch;this.isIndexed=options;return this.setActive(items,width,height,depth)}generate(data){return UData.getStreamer(data,this.samples,4,this.items)}setActive(items,width,height,depth){let ref;if(items!==this.active.items||width!==this.active.width||height!==
this.active.height||depth!==this.active.depth){[this.active.items,this.active.width,this.active.height,this.active.depth]=Array.from([items,width,height,depth]);null!=this.floatCompose&&this.floatCompose.cover(width,height,depth);null!=this.byteCompose&&this.byteCompose.cover(width*this.stretch,height,depth);({items}=this);({width}=this.active);height=1===this.depth?this.active.height:this.height;({depth}=this.active);var w=items*width*this.stretch,h=height*depth;[this.sampled.items,this.sampled.width,
this.sampled.height,this.sampled.depth]=Array.from([items,width,height,depth]);[this.rect.w,this.rect.h]=Array.from([w,h]);return[this.pad.x,this.pad.y,this.pad.z,this.pad.w]=Array.from(ref=[this.sampled.width-this.active.width,this.sampled.height-this.active.height,this.sampled.depth-this.active.depth,this.sampled.items-this.active.items]),ref}}update(camera){null!=this.floatMemo&&this.floatMemo.render(camera);return null!=this.byteMemo?this.byteMemo.render(camera):void 0}post(){const currentTarget=
this.renderer.getRenderTarget();this.renderer.setRenderTarget(this.byteMemo.target.targets[0]);this.gl.readPixels(0,0,this.rect.w,this.rect.h,this.gl.RGBA,this.gl.UNSIGNED_BYTE,this.bytes);this.renderer.setRenderTarget(currentTarget)}readFloat(n){return null!=this.floatMemo?this.floatMemo.read(n):void 0}readByte(n){return null!=this.byteMemo?this.byteMemo.read(n):void 0}setCallback(callback){this.emitter=this.callback(callback)}callback(callback){if(!this.isIndexed)return callback;const n=this.width,
m=this.height,p=this.items,f=function(x,y,z,w){let idx=w;const ll=idx%p;idx=(idx-ll)/p;const ii=idx%n;idx=(idx-ii)/n;const jj=idx%m;idx=(idx-jj)/m;return callback(x,y,z,w,ii,jj,idx,ll)};f.reset=()=>"function"===typeof callback.reset?callback.reset():void 0;return f}iterate(){let j,k,l,emit=this.emitter;"function"===typeof emit.reset&&emit.reset();const {consume,skip,count,done,reset}=this.streamer;reset();const n=this.sampled.width|0;let m=this.sampled.height|0;const p=this.sampled.items|0,padX=this.pad.x|
0,padY=this.pad.y|0,padW=this.pad.w|0,limit=n*m*p*((this.sampled.depth|0)-(this.pad.z|0));if(!this.isIndexed){const callback=emit;emit=(x,y,z,w)=>callback(x,y,z,w,i,j,k,l)}let i=j=k=l=m=0;for(;!done()&&m<limit;){m++;const repeat=consume(emit);++l===p-padW&&(skip(padX),l=0,++i===n-padX&&(skip(p*padX),i=0,++j===m-padY&&(skip(p*n*padY),j=0,k++)));if(!1===repeat)break}return Math.floor(count()/p)}dispose(){null!=this.floatMemo&&this.floatMemo.unadopt(this.floatCompose);null!=this.floatMemo&&this.floatMemo.dispose();
null!=this.floatCompose&&this.floatCompose.dispose();null!=this.byteMemo&&this.byteMemo.unadopt(this.byteCompose);null!=this.byteMemo&&this.byteMemo.dispose();null!=this.byteCompose&&this.byteCompose.dispose();return this.floatMemo=this.byteMemo=this.floatCompose=this.byteCompose=null}}exports.Readback=Readback}
//# sourceMappingURL=module$node_modules$mathbox$build$esm$render$buffer$readback.js.map
