{"version":3,"sources":["nextjournal/clojure_mode/test_utils.cljs"],"mappings":"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","names":["nextjournal.clojure-mode.test-utils/make-state","extensions","doc","vec__66870","cljs.core.nth","ranges","cljs.core/re-seq","cljs.core.reduce","p__66873","vec__66874","match","cljs.core._EQ_","cljs.core.conj","js/module$node_modules$$codemirror$state$dist$index_cjs.EditorSelection","clojure.string/starts-with?","cljs.core.subs","cljs.core/count","js/module$node_modules$$codemirror$state$dist$index_cjs.EditorState","cljs.core/seq","cljs.core/to-array","js/undefined","G__66877","Array66878","nextjournal.clojure-mode.test-utils/state-str","state","cljs.core/reverse","p__66879","map__66880","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","obj66882","obj66883","obj66884","empty","from","to","nextjournal.clojure-mode.test-utils/apply-cmd","cmd","cljs.core/deref","!tr","cljs.core.atom","_","G__66886","p1__66885#","cljs.core/reset!","tr","obj66887","js/Error","nextjournal.clojure-mode.test-utils/apply-f","cljs.core/array?","cljs.core/fn?"],"sourcesContent":["(ns nextjournal.clojure-mode.test-utils\n  (:require [\"@codemirror/state\" :as cm-state\n             :refer [EditorState EditorSelection Extension StateCommand\n                     ChangeSet ChangeDesc TransactionSpec StrictTransactionSpec]]\n            [applied-science.js-interop :as j]\n            [clojure.string :as str]\n            [nextjournal.clojure-mode.extensions.formatting :as format]))\n\n;; (de)serialize cursors| and <selections> for testing\n\n(defn make-state [extensions doc]\n  (let [[doc ranges] (->> (re-seq #\"\\||<[^>]*?>|[^<>|]+\" doc)\n                          (reduce (fn [[^string doc ranges] match]\n                                    (cond (= match \"|\")\n                                          [doc (conj ranges (.cursor EditorSelection (count doc)))]\n\n                                          (str/starts-with? match \"<\")\n                                          [(str doc (subs match 1 (dec (count match))))\n                                           (conj ranges (.range EditorSelection\n                                                                (count doc)\n                                                                (+ (count doc) (- (count match) 2))))]\n                                          :else\n                                          [(str doc match) ranges])) [\"\" []]))]\n    (.create EditorState\n             #js{:doc doc\n                 :selection (if (seq ranges)\n                              (.create EditorSelection (to-array ranges))\n                              js/undefined)\n                 :extensions (cond-> #js[(.. EditorState -allowMultipleSelections (of true))]\n                               extensions\n                               (j/push! extensions))})))\n\n(defn state-str [^js state]\n  (let [doc (str (.-doc state))]\n    (->> (.. state -selection -ranges)\n         reverse\n         (reduce (j/fn [doc ^:js {:keys [empty from to]}]\n                   (if empty\n                     (str (subs doc 0 from) \"|\" (subs doc from))\n                     (str (subs doc 0 from) \"<\" (subs doc from to) \">\" (subs doc to)))) doc))))\n\n(comment\n (-> (make-state #js[] \"<a>b|c<d\\n>a<b>c|\")\n     (state-str)\n     (= \"<a>b|c<d\\n>a<b>c|\"))\n\n )\n\n(defn apply-cmd [extensions cmd doc]\n  (let [state (make-state extensions doc)\n        !tr (atom nil)\n        _ (cmd #js{:state state\n                   :dispatch #(reset! !tr %)})\n        tr @!tr]\n    (state-str (j/get tr :state))))\n\n(defn apply-f [extensions cmd doc]\n  {:pre [(array? extensions)\n         (fn? cmd)\n         (string? doc)]}\n  (let [state (make-state extensions doc)\n        tr (cmd state)]\n    (state-str (if tr (.-state tr) state))))\n"]}