{"version":3,"sources":["nextjournal/markdown/parser.cljc"],"mappings":"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","names":["nextjournal.markdown.parser/get-in*","applied-science.js-interop/get-in","nextjournal.markdown.parser/update*","applied-science.js-interop/update!","nextjournal.markdown.parser/re-idx-seq","re","text","rex","js/RegExp","cljs.core.take_while","cljs.core/some?","cljs.core.repeatedly","temp__5757__auto__","m","cljs.core/vec","nextjournal.markdown.parser/inc-last","path","cljs.core.update","cljs.core/count","cljs.core/inc","p__85403","map__85404","cljs.core/--destructure-map","cljs.core.get","nextjournal.markdown.parser/hlevel","_token","hn","G__85405","cljs.core/re-matches","cljs.core/second","cljs.reader.read_string","nextjournal.markdown.parser/parse-fence-info","info-str","e85406","tokens","clojure.string/trim","clojure.string/replace","clojure.string.split","cljs.core.reduce","p__85407","map__85408","info-map","language","token","vec__85409","cljs.core.nth","_","k","v","clojure.string/starts-with?","cljs.core.assoc","and__4251__auto__","cljs.core.keyword","cljs.core/not","nextjournal.markdown.parser/text-node","nextjournal.markdown.parser/tag-node","nextjournal.markdown.parser/formula","nextjournal.markdown.parser/block-formula","nextjournal.markdown.parser/sidenote-ref","ref","nextjournal.markdown.parser/node","type","content","attrs","top-level","G__85413","cljs.core/seq","cljs.core.merge","p__85414","map__85415","nextjournal.markdown.parser/empty-text-node?","t","cljs.core._EQ_","cljs.core/empty?","p__85416","map__85417","nextjournal.markdown.parser/push-node","doc","node","G__85418","cljs.core.update_in","cljs.core/pop","cljs.core/conj","nextjournal.markdown.parser/push-nodes","cljs.core.partial","cljs.core/reduce","var_args","G__85421","nextjournal.markdown.parser/open-node","js/Error","nextjournal.markdown.parser.open_node","cljs.core/into","nextjournal.markdown.parser/ppop","cljs.core.comp","nextjournal.markdown.parser/close-node","args__4870__auto__","len__4864__auto__","i__4865__auto__","argseq__4871__auto__","cljs.core/IndexedSeq","nextjournal.markdown.parser/update-current","p__85427","map__85428","seq85424","G__85425","cljs.core/first","cljs.core/next","G__85426","self__4851__auto__","fn","args","cljs.core.apply","cljs.core/update-in","p__85429","map__85430","nextjournal.markdown.parser/into-toc","toc","toc-item","heading-level","l","toc-path","type-path","cljs.core.get_in","cljs.core/assoc-in","cljs.core.fnil","cljs.core.conj","x__4336__auto__","y__4337__auto__","p__85431","map__85432","nextjournal.markdown.parser/add-to-toc","h","G__85433","cljs.core/pos-int?","p__85434","map__85435","nextjournal.markdown.parser/set-title-when-missing","title","heading","G__85436","nextjournal.markdown.transform/->text","p__85437","map__85438","nextjournal.markdown.parser/add-title+toc","rf","xf","cljs.core.filter","js/nextjournal","js/nextjournal.markdown","js/nextjournal.markdown.parser","js/nextjournal.markdown.parser.apply-token","method-table__4747__auto__","cljs.core.atom","prefer-table__4748__auto__","method-cache__4749__auto__","cached-hierarchy__4750__auto__","hierarchy__4751__auto__","fexpr__85442","cljs.core/MultiFn","cljs.core.symbol","nextjournal.markdown.parser/apply-token","_doc","cljs.core.prn","p__85443","map__85444","doc-level","map__85445","G__85446","p__85447","map__85448","hidden","p__85454","map__85455","map__85456","has-todos","p__85457","map__85458","p__85460","map__85461","map__85462","todo","p__85467","map__85468","nextjournal.markdown.parser.update_current","cljs.core/dissoc","p__85484","map__85489","c","p__85490","map__85491","i","G__85492","G__85493","G__85494","G__85495","G__85496","G__85497","nextjournal.markdown.parser/text-tokenizers","match","cljs.core.subs","p__85516","map__85517","nextjournal.markdown.parser/normalize-tokenizer","tokenizer","doc-handler","handler","regex","tokenizer-fn","or__4253__auto__","G__85541","p__85550","map__85551","p__85555","p__85556","map__85559","map__85560","nextjournal.markdown.parser/tokenize-text-node","tkz","cljs.core/fn?","idx-seq","map__85563","text-hnode","s","nodes","remaining-text","p__85565","p__85566","map__85568","vec__85569","acc","start","end","cljs.core/subs","G__85576","cljs.core/reverse","G__85577","p__85583","p__85584","map__85585","map__85586","text-tokenizers","p__85587","map__85588","G__85589","G__85590","cljs.core.dissoc","cljs.core.mapcat","p__85591","map__85592","p__85596","map__85597","ts","nextjournal.markdown.parser/apply-tokens","p__85599","map__85600","p__85605","map__85606","p__85611","map__85612","children","G__85615","G__85616","p__85640","map__85641","nextjournal.markdown.parser/pairs->kmap","pairs","cljs.core.into","cljs.core.map","cljs.core.juxt","cljs.core/keyword","mapify-attrs-xf","x","nextjournal.markdown.parser/empty-doc","G__85651","nextjournal.markdown.parser/parse","nextjournal.markdown.parser.parse","cljs.core/map","p__85656","p__85657","map__85658","vec__85659","nextjournal.markdown.parser/section-at","pos","map__85664","section-level","in-section?","p__85665","map__85666","cljs.core/cons","cljs.core.drop"],"sourcesContent":[";; # \ud83e\udde9 Parsing\n;;\n;; Deals with transforming a sequence of tokens obtained by [markdown-it] into a nested AST composed of nested _nodes_.\n;;\n;; A _node_ is a clojure map and has no closed specification at the moment. We do follow a few conventions for its keys:\n;;\n;; - `:type` a keyword (:heading, :paragraph, :text, :code etc.) present on all nodes.\n;;\n;; When a node contains other child nodes, then it will have a\n;;\n;; - `:content` a collection of nodes representing nested content\n;;\n;; when a node is a textual leaf (as in a `:text` or `:formula` nodes) it carries a\n;; - `:text` key with a string value\n;;\n;; Other keys might include e.g.\n;;\n;; - `:info` specific of fenced code blocks\n;; - `:heading-level` specific of `:heading` nodes\n;; - `:attrs` attributes as passed by markdown-it tokens (e.g `{:style \"some style info\"}`)\n(ns nextjournal.markdown.parser\n  (:require [clojure.string :as str]\n            [nextjournal.markdown.transform :as md.transform]\n            #?@(:cljs [[applied-science.js-interop :as j]\n                       [cljs.reader :as reader]])))\n\n;; clj common accessors\n(def get-in* #?(:clj get-in :cljs j/get-in))\n(def update* #?(:clj update :cljs j/update!))\n\n#?(:clj (defn re-groups* [m] (let [g (re-groups m)] (cond-> g (not (vector? g)) vector))))\n(defn re-idx-seq\n  \"Takes a regex and a string, returns a seq of triplets comprised of match groups followed by indices delimiting each match.\"\n  [re text]\n  #?(:clj (let [m (re-matcher re text)]\n            (take-while some? (repeatedly #(when (.find m) [(re-groups* m) (.start m) (.end m)]))))\n     :cljs (let [rex (js/RegExp. (.-source re) \"g\")]\n             (take-while some? (repeatedly #(when-some [m (.exec rex text)] [(vec m) (.-index m) (.-lastIndex rex)]))))))\n\n\n(comment (re-idx-seq #\"\\{\\{([^{]+)\\}\\}\" \"foo {{hello}} bar\"))\n(comment (re-idx-seq #\"\\{\\{[^{]+\\}\\}\" \"foo {{hello}} bar\"))\n;; region node operations\n;; helpers\n(defn inc-last [path] (update path (dec (count path)) inc))\n(defn hlevel [{:as _token hn :tag}] (when (string? hn) (some-> (re-matches #\"h([\\d])\" hn) second #?(:clj read-string :cljs reader/read-string))))\n\n;; `parse-fence-info` ingests nextjournal, GFM, Pandoc and RMarkdown fenced code block info (any text following the leading 3 backticks) and returns a map\n;;\n;; _nextjournal_ / _GFM_\n;;\n;;    ```python id=2e3541da-0735-4b7f-a12f-4fb1bfcb6138\n;;    python code\n;;    ```\n;;\n;; _Pandoc_\n;;\n;;    ```{#pandoc-id .languge .extra-class key=Val}\n;;    code in language\n;;    ```\n;;\n;; _Rmd_\n;;\n;;    ```{r cars, echo=FALSE}\n;;    R code\n;;    ```\n;;\n;; See also:\n;; - https://github.github.com/gfm/#info-string\n;; - https://pandoc.org/MANUAL.html#fenced-code-blocks\n;; - https://rstudio.com/wp-content/uploads/2016/03/rmarkdown-cheatsheet-2.0.pdf\"\n\n(defn parse-fence-info [info-str]\n  (try\n    (when (string? info-str)\n      (let [tokens (-> info-str\n                       str/trim\n                       (str/replace #\"[\\{\\}\\,]\" \"\")         ;; remove Pandoc/Rmarkdown brackets and commas\n                       (str/replace \".\" \"\")                 ;; remove dots\n                       (str/split #\" \"))]                   ;; split by spaces\n        (reduce\n         (fn [{:as info-map :keys [language]} token]\n           (let [[_ k v] (re-matches #\"^([^=]+)=([^=]+)$\" token)]\n             (cond\n               (str/starts-with? token \"#\") (assoc info-map :id (str/replace token #\"^#\" \"\")) ;; pandoc #id\n               (and k v) (assoc info-map (keyword k) v)\n               (not language) (assoc info-map :language token) ;; language is the first simple token which is not a pandoc's id\n               :else (assoc info-map (keyword token) true))))\n         {}\n         tokens)))\n    (catch #?(:clj Throwable :cljs :default) _ {})))\n\n(comment\n  (parse-fence-info \"python runtime-id=5f77e475-6178-47a3-8437-45c9c34d57ff\")\n  (parse-fence-info \"{#some-id .lang foo=nex}\")\n  (parse-fence-info \"#id clojure\")\n  (parse-fence-info \"clojure #id\")\n  (parse-fence-info \"clojure\")\n  (parse-fence-info \"{r cars, echo=FALSE}\"))\n\n;; leaf nodes\n(defn text-node [text] {:type :text :text text})\n(defn tag-node [text] {:type :hashtag :text text})\n(defn formula [text] {:type :formula :text text})\n(defn block-formula [text] {:type :block-formula :text text})\n(defn sidenote-ref [ref] {:type :sidenote-ref :content [(text-node (str (inc ref)))]})\n\n;; node constructors\n(defn node\n  [type content attrs top-level]\n  (cond-> {:type type :content content}\n    (seq attrs) (assoc :attrs attrs)\n    (seq top-level) (merge top-level)))\n\n(defn empty-text-node? [{text :text t :type}] (and (= :text t) (empty? text)))\n\n(defn push-node [{:as doc ::keys [path]} node]\n  (cond-> doc\n    (not (empty-text-node? node)) ;; \u2b05 mdit produces empty text tokens at mark boundaries, see edge cases below\n    (-> #_doc\n        (update ::path inc-last)\n        (update-in (pop path) conj node))))\n(def push-nodes (partial reduce push-node))\n\n(defn open-node\n  ([doc type] (open-node doc type {}))\n  ([doc type attrs] (open-node doc type attrs {}))\n  ([doc type attrs top-level]\n   (-> doc\n       (push-node (node type [] attrs top-level))\n       (update ::path into [:content -1]))))\n;; after closing a node, document ::path will point at it\n(def ppop (comp pop pop))\n(defn close-node [doc] (update doc ::path ppop))\n(defn update-current [{:as doc path ::path} fn & args] (apply update-in doc path fn args))\n\n(comment                                                    ;; path after call\n  (-> empty-doc                                             ;; [:content -1]\n      (open-node :heading)                                  ;; [:content 0 :content -1]\n      (push-node {:node/type :text :text \"foo\"})            ;; [:content 0 :content 0]\n      (push-node {:node/type :text :text \"foo\"})            ;; [:content 0 :content 1]\n      close-node                                            ;; [:content 1]\n\n      (open-node :paragraph)                                ;; [:content 1 :content]\n      (push-node {:node/type :text :text \"hello\"})\n      close-node\n      (open-node :bullet-list)\n      ;;\n      ))\n;; endregion\n\n;; region TOC builder:\n;; toc nodes are heading nodes but with `:type` `:toc` and an extra branching along\n;; the key `:children` representing the sub-sections of the node\n(defn into-toc [toc {:as toc-item :keys [heading-level]}]\n  (loop [toc toc l heading-level toc-path [:children]]\n    ;; `toc-path` is `[:children i\u2081 :children i\u2082 ... :children]`\n    (let [type-path (assoc toc-path (dec (count toc-path)) :type)]\n      (cond\n        ;; insert intermediate default empty :content collections for the final update-in (which defaults to maps otherwise)\n        (not (get-in toc toc-path))\n        (recur (assoc-in toc toc-path []) l toc-path)\n\n        ;; fill in toc types for non-contiguous jumps like h1 -> h3\n        (not (get-in toc type-path))\n        (recur (assoc-in toc type-path :toc) l toc-path)\n\n        (= 1 l)\n        (update-in toc toc-path (fnil conj []) toc-item)\n\n        :else\n        (recur toc\n               (dec l)\n               (conj toc-path\n                     (max 0 (dec (count (get-in toc toc-path)))) ;; select last child at level if it exists\n                     :children))))))\n\n(defn add-to-toc [doc {:as h :keys [heading-level]}]\n  (cond-> doc (pos-int? heading-level) (update :toc into-toc (assoc h :type :toc))))\n\n(defn set-title-when-missing [{:as doc :keys [title]} heading]\n  (cond-> doc (nil? title) (assoc :title (md.transform/->text heading))))\n\n(defn add-title+toc\n  \"Computes and adds a :title and a :toc to the document-like structure `doc` which might have not been constructed by means of `parse`.\"\n  [{:as doc :keys [content]}]\n  (let [rf (fn [doc heading] (-> doc (add-to-toc heading) (set-title-when-missing heading)))\n        xf (filter (comp #{:heading} :type))]\n    (reduce (xf rf) (assoc doc :toc {:type :toc}) content)))\n\n(comment\n (-> {:type :toc}\n     ;;(into-toc {:heading-level 3 :title \"Foo\"})\n     ;;(into-toc {:heading-level 2 :title \"Section 1\"})\n     (into-toc {:heading-level 1 :title \"Title\" :type :toc})\n     (into-toc {:heading-level 4 :title \"Section 2\" :type :toc})\n     ;;(into-toc {:heading-level 4 :title \"Section 2.1\"})\n     ;;(into-toc {:heading-level 2 :title \"Section 3\"})\n     )\n\n (-> \"# Top _Title_\n\npar\n\n### Three\n\n## Two\n\npar\n- and a nested\n- ### Heading not included\n\nfoo\n\n## Two Again\n\npar\n\n# One Again\n\n[[TOC]]\n\n#### Four\n\nend\"\n     nextjournal.markdown/parse\n     :toc\n     ))\n;; endregion\n\n;; region token handlers\n(declare apply-tokens)\n(defmulti apply-token (fn [_doc token] (:type token)))\n(defmethod apply-token :default [doc token]\n  (prn :apply-token/unknown-type {:token token})\n  doc)\n\n;; blocks\n(defmethod apply-token \"heading_open\" [doc token] (open-node doc :heading {} {:heading-level (hlevel token)}))\n(defmethod apply-token \"heading_close\" [doc {doc-level :level}]\n  (let [{:as doc ::keys [path]} (close-node doc)\n        heading (-> doc (get-in path) (assoc :path path))]\n    (cond-> doc (zero? doc-level) (-> (add-to-toc heading) (set-title-when-missing heading)))))\n;; for building the TOC we just care about headings at document top level (not e.g. nested under lists) \u2b06\n\n(defmethod apply-token \"paragraph_open\" [doc {:as _token :keys [hidden]}] (open-node doc (if hidden :plain :paragraph)))\n(defmethod apply-token \"paragraph_close\" [doc _token] (close-node doc))\n\n(defmethod apply-token \"bullet_list_open\" [doc {{:as attrs :keys [has-todos]} :attrs}] (open-node doc (if has-todos :todo-list :bullet-list) attrs))\n(defmethod apply-token \"bullet_list_close\" [doc _token] (close-node doc))\n\n(defmethod apply-token \"ordered_list_open\" [doc {:keys [attrs]}] (open-node doc :numbered-list attrs))\n(defmethod apply-token \"ordered_list_close\" [doc _token] (close-node doc))\n\n(defmethod apply-token \"list_item_open\" [doc {{:as attrs :keys [todo]} :attrs}] (open-node doc (if todo :todo-item :list-item) attrs))\n(defmethod apply-token \"list_item_close\" [doc _token] (close-node doc))\n\n(defmethod apply-token \"math_block\" [doc {text :content}] (push-node doc (block-formula text)))\n(defmethod apply-token \"math_block_end\" [doc _token] doc)\n\n(defmethod apply-token \"hr\" [doc _token] (push-node doc {:type :ruler}))\n\n(defmethod apply-token \"blockquote_open\" [doc _token] (open-node doc :blockquote))\n(defmethod apply-token \"blockquote_close\" [doc _token] (close-node doc))\n\n(defmethod apply-token \"tocOpen\" [doc _token] (open-node doc :toc))\n(defmethod apply-token \"tocBody\" [doc _token] doc) ;; ignore body\n(defmethod apply-token \"tocClose\" [doc _token] (-> doc close-node (update-current dissoc :content)))\n\n(defmethod apply-token \"code_block\" [doc {:as _token c :content}]\n  (-> doc\n      (open-node :code)\n      (push-node (text-node c))\n      close-node))\n(defmethod apply-token \"fence\" [doc {:as _token i :info c :content}]\n  (-> doc\n      (open-node :code {} (assoc (parse-fence-info i) :info i))\n      (push-node (text-node c))\n      close-node))\n\n;; footnotes\n(defmethod apply-token \"sidenote_ref\" [doc token] (push-node doc (sidenote-ref (get-in* token [:meta :id]))))\n(defmethod apply-token \"sidenote_anchor\" [doc token] doc)\n(defmethod apply-token \"sidenote_open\" [doc token] (-> doc (assoc :sidenotes? true) (open-node :sidenote {:ref (get-in* token [:meta :id])})))\n(defmethod apply-token \"sidenote_close\" [doc token] (close-node doc))\n(defmethod apply-token \"sidenote_block_open\" [doc token] (-> doc (assoc :sidenotes? true) (open-node :sidenote {:ref (get-in* token [:meta :id])})))\n(defmethod apply-token \"sidenote_block_close\" [doc token] (close-node doc))\n\n;; tables\n;; table data tokens might have {:style \"text-align:right|left\"} attrs, maybe better nested node > :attrs > :style ?\n(defmethod apply-token \"table_open\" [doc _token] (open-node doc :table))\n(defmethod apply-token \"table_close\" [doc _token] (close-node doc))\n(defmethod apply-token \"thead_open\" [doc _token] (open-node doc :table-head))\n(defmethod apply-token \"thead_close\" [doc _token] (close-node doc))\n(defmethod apply-token \"tr_open\" [doc _token] (open-node doc :table-row))\n(defmethod apply-token \"tr_close\" [doc _token] (close-node doc))\n(defmethod apply-token \"th_open\" [doc token] (open-node doc :table-header (:attrs token)))\n(defmethod apply-token \"th_close\" [doc _token] (close-node doc))\n(defmethod apply-token \"tbody_open\" [doc _token] (open-node doc :table-body))\n(defmethod apply-token \"tbody_close\" [doc _token] (close-node doc))\n(defmethod apply-token \"td_open\" [doc token] (open-node doc :table-data (:attrs token)))\n(defmethod apply-token \"td_close\" [doc _token] (close-node doc))\n\n(comment\n  (->\n\"\n| Syntax |  JVM                     | JavaScript                      |\n|--------|:------------------------:|--------------------------------:|\n|   foo  |  Loca _lDate_ ahoiii     | goog.date.Date                  |\n|   bar  |  java.time.LocalTime     | some [kinky](link/to/something) |\n|   bag  |  java.time.LocalDateTime | $\\\\phi$                         |\n\"\n    nextjournal.markdown/parse\n    nextjournal.markdown.transform/->hiccup\n    ))\n\n;; ## Handling of Text Tokens\n;;\n;;    normalize-tokenizer :: {:regex, :doc-handler} | {:tokenizer-fn, :handler} -> Tokenizer\n;;    Tokenizer :: {:tokenizer-fn :: TokenizerFn, :doc-handler :: DocHandler}\n;;\n;;    Match :: Any\n;;    Handler :: Match -> Node\n;;    IndexedMatch :: (Match, Int, Int)\n;;    TokenizerFn :: String -> [IndexedMatch]\n;;    DocHandler :: Doc -> {:match :: Match} -> Doc\n\n(def text-tokenizers\n  [{:regex #\"(^|\\B)#[\\w-]+\"\n    :handler (fn [match] {:type :hashtag :text (subs (match 0) 1)})}\n   {:regex #\"\\[\\[([^\\]]+)\\]\\]\"\n    :handler (fn [match] {:type :internal-link :text (match 1)})}])\n\n(defn normalize-tokenizer\n  \"Normalizes a map of regex and handler into a Tokenizer\"\n  [{:as tokenizer :keys [doc-handler handler regex tokenizer-fn]}]\n  (assert (and (or doc-handler handler) (or regex tokenizer-fn)))\n  (cond-> tokenizer\n    (not doc-handler) (assoc :doc-handler (fn [doc {:keys [match]}] (push-node doc (handler match))))\n    (not tokenizer-fn) (assoc :tokenizer-fn (partial re-idx-seq regex))))\n\n(defn tokenize-text-node [{:as tkz :keys [tokenizer-fn doc-handler]} {:as node :keys [text]}]\n  ;; TokenizerFn -> HNode -> [HNode]\n  (assert (and (fn? tokenizer-fn) (fn? doc-handler) (string? text))\n          {:text text :tokenizer tkz})\n  (let [idx-seq (tokenizer-fn text)]\n    (if (seq idx-seq)\n      (let [text-hnode (fn [s] (assoc (text-node s) :doc-handler push-node))\n            {:keys [nodes remaining-text]}\n            (reduce (fn [{:as acc :keys [remaining-text]} [match start end]]\n                      (-> acc\n                          (update :remaining-text subs 0 start)\n                          (cond->\n                            (< end (count remaining-text))\n                            (update :nodes conj (text-hnode (subs remaining-text end))))\n                          (update :nodes conj {:doc-handler doc-handler\n                                               :match match :text text\n                                               :start start :end end})))\n                    {:remaining-text text :nodes ()}\n                    (reverse idx-seq))]\n        (cond-> nodes\n          (seq remaining-text)\n          (conj (text-hnode remaining-text))))\n      [node])))\n\n(defmethod apply-token \"text\" [{:as doc :keys [text-tokenizers]} {:keys [content]}]\n  (reduce (fn [doc {:as node :keys [doc-handler]}] (doc-handler doc (dissoc node :doc-handler)))\n          doc\n          (reduce (fn [nodes tokenizer]\n                    (mapcat (fn [{:as node :keys [type]}]\n                              (if (= :text type) (tokenize-text-node tokenizer node) [node]))\n                            nodes))\n                  [{:type :text :text content :doc-handler push-node}]\n                  text-tokenizers)))\n\n(comment\n  (def mustache (normalize-tokenizer {:regex #\"\\{\\{([^\\{]+)\\}\\}\" :handler (fn [m] {:type :eval :text (m 1)})}))\n  (tokenize-text-node mustache {:text \"{{what}} the {{hellow}}\"})\n  (apply-token (assoc empty-doc :text-tokenizers [mustache])\n               {:type \"text\" :content \"foo [[bar]] dang #hashy taggy [[what]] #dangy foo [[great]] and {{eval}} me\"})\n\n  (nextjournal.markdown/parse \"foo [[bar]] dang #hashy taggy [[what]] #dangy foo [[great]]\" )\n\n  (parse (assoc empty-doc\n                :text-tokenizers\n                [(normalize-tokenizer {:regex #\"\\{\\{([^\\{]+)\\}\\}\"\n                                       :doc-handler (fn [doc {[_ meta] :match}]\n                                                      (update-in doc (pop (pop (::path ddoc))) assoc :meta meta))})])\n         (nextjournal.markdown/tokenize \"# Title {{id=heading}}\n* one\n* two\")))\n\n;; inlines\n(defmethod apply-token \"inline\" [doc {:as _token ts :children}] (apply-tokens doc ts))\n(defmethod apply-token \"math_inline\" [doc {text :content}] (push-node doc (formula text)))\n(defmethod apply-token \"math_inline_double\" [doc {text :content}] (push-node doc (formula text)))\n(defmethod apply-token \"softbreak\" [doc _token] (push-node doc {:type :softbreak}))\n\n;; images\n(defmethod apply-token \"image\" [doc {:keys [attrs children]}] (-> doc (open-node :image attrs) (apply-tokens children) close-node))\n\n;; marks\n(defmethod apply-token \"em_open\" [doc _token] (open-node doc :em))\n(defmethod apply-token \"em_close\" [doc _token] (close-node doc))\n(defmethod apply-token \"strong_open\" [doc _token] (open-node doc :strong))\n(defmethod apply-token \"strong_close\" [doc _token] (close-node doc))\n(defmethod apply-token \"s_open\" [doc _token] (open-node doc :strikethrough))\n(defmethod apply-token \"s_close\" [doc _token] (close-node doc))\n(defmethod apply-token \"link_open\" [doc token] (open-node doc :link (:attrs token)))\n(defmethod apply-token \"link_close\" [doc _token] (close-node doc))\n(defmethod apply-token \"code_inline\" [doc {text :content}] (-> doc (open-node :monospace) (push-node (text-node text)) close-node))\n\n;; html (ignored)\n(defmethod apply-token \"html_inline\" [doc _] doc)\n(defmethod apply-token \"html_block\" [doc _] doc)\n;; endregion\n\n;; region data builder api\n(defn pairs->kmap [pairs] (into {} (map (juxt (comp keyword first) second)) pairs))\n(defn apply-tokens [doc tokens]\n  (let [mapify-attrs-xf (map (fn [x] (update* x :attrs pairs->kmap)))]\n    (reduce (mapify-attrs-xf apply-token) doc tokens)))\n\n(def empty-doc {:type :doc\n                :content []\n                :toc {:type :toc}\n                ::path [:content -1] ;; private\n                :text-tokenizers text-tokenizers})\n\n(defn parse\n  \"Takes a doc and a collection of markdown-it tokens, applies tokens to doc. Uses an emtpy doc in arity 1.\"\n  ([tokens] (parse empty-doc tokens))\n  ([doc tokens] (-> doc\n                    (update :text-tokenizers (partial map normalize-tokenizer))\n                    (apply-tokens tokens)\n                    (dissoc ::path :text-tokenizers))))\n\n(comment\n\n (-> \"# Markdown Data\n\nsome _emphatic_ **strong** [link](https://foo.com)\n\n---\n\n> some ~~nice~~ quote\n> for fun\n\n## Formulas\n\n[[TOC]]\n\n$$\\\\Pi^2$$\n\n- [ ]  and\n- [x]  some $\\\\Phi_{\\\\alpha}$ latext\n- [ ]  bullets\n\n## Sidenotes\n\nhere [^mynote] to somewhere\n\n## Fences\n\n```py id=\\\"aaa-bbb-ccc\\\"\n1\nprint(\\\"this is some python\\\")\n2\n3\n```\n\n![Image Text](https://img.icons8.com/officel/16/000000/public.png)\n\nHline Section\n-------------\n\n### but also [[indented code]]\n\n    import os\n    os.listdir('/')\n\nor monospace mark [`real`](/foo/bar) fun.\n\n[^mynote]: Here you _can_ `explain` at lenght\n\"\n     nextjournal.markdown/tokenize\n     parse\n     ;;seq\n     ;;(->> (take 10))\n     ;;(->> (take-last 4))\n     ))\n;; endregion\n\n;; region zoom-in at section\n(defn section-at [{:as doc :keys [content]} [_ pos :as path]]\n  ;; TODO: generalize over path (zoom-in at)\n  ;; supports only top-level headings atm (as found in TOC)\n  (let [{:as h section-level :heading-level} (get-in doc path)\n        in-section? (fn [{l :heading-level}] (or (not l) (< section-level l)))]\n    (when section-level\n      {:type :doc\n       :content (cons h\n                      (->> content\n                           (drop (inc pos))\n                           (take-while in-section?)))})))\n\n(comment\n (some-> \"# Title\n\n## Section 1\n\nfoo\n\n- # What is this? (no!)\n- maybe\n\n### Section 1.2\n\n## Section 2\n\nsome par\n\n### Section 2.1\n\nsome other par\n\n### Section 2.2\n\n#### Section 2.2.1\n\ntwo two one\n\n#### Section 2.2.2\n\ntwo two two\n\n## Section 3\n\nsome final par\"\n    nextjournal.markdown/parse\n    (section-at [:content 9])                         ;; \u2b05 paths are stored in TOC sections\n    nextjournal.markdown.transform/->hiccup))\n;; endregion\n"]}